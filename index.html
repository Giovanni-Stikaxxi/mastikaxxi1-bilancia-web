<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Bilancia 1 - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Migliorie estetiche */
.badge {
    background: #eee;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.9em;
}

.stato-online {
    color: #4CAF50;
    font-weight: bold;
}

.stato-offline {
    color: #E53935;
    font-weight: bold;
}

table tbody tr:nth-child(odd) {
    background: #f7f7f7;
}
</style>

</head>

<body>

<div class="header-logos">
    <img src="logo.png" class="logo">
    <h1>Bilancia 1 - Dashboard</h1>
    <img src="logo.png" class="logo">
</div>

<!-- CARD CON PESO E VARIAZIONE AFFIANCATI -->
<div class="card row-two">
    
    <div class="col">
        <h2>Peso Attuale</h2>
        <div id="pesoAttuale" class="big-value">--.- kg</div>
    </div>

    <div class="col">
        <h2>Variazione 24h</h2>
        <div id="var24h" class="big-value-small">-- kg</div>
        <div class="chart-container-small">
            <canvas id="graficoVar24h"></canvas>
        </div>
    </div>

</div>

<div class="card">
    <h2>Stato Bilancia</h2>
    <p><strong>Stato:</strong> <span id="statoConn">--</span></p>
    <p><strong>Ultimo aggiornamento:</strong> <span id="ultimoAgg">--</span></p>
    <p><strong>Rete WiFi:</strong> <span id="reteWifi">--</span></p>
</div>

<div class="card">
    <h2>Ultimi 10 Pesi</h2>
    <table>
        <thead>
            <tr><th>Ora</th><th>Peso (kg)</th></tr>
        </thead>
        <tbody id="tabellaPesi"></tbody>
    </table>
</div>

<!-- GRAFICO MATLAB INTEGRATO -->
<div class="card">
    <h2>Analisi MATLAB (ThingSpeak)</h2>
    <div class="matlab-container">
        <iframe 
            src="https://thingspeak.mathworks.com/apps/matlab_visualizations/646817"
            class="matlab-frame"
            loading="lazy">
        </iframe>
    </div>
</div>

<div class="card">
    <h2>Storico Peso</h2>

    <div class="btn-group">
        <button onclick="caricaGrafico(96)">Ultime 24 ore</button>
        <button onclick="caricaGrafico(672)">Ultimi 7 giorni</button>
        <button onclick="caricaGrafico(2880)">Ultimi 30 giorni</button>
    </div>

    <div class="chart-container">
        <canvas id="graficoPeso" height="100"></canvas>
    </div>
</div>

<script>
const channelID = 3171602;
const readAPIKey = "JQ1UUYT4R4T83V0V";

let chart;
let chartVar;

// ----------------------
// PESO ATTUALE
// ----------------------
async function aggiornaPesoAttuale() {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`;
    const r = await fetch(url);
    const data = await r.json();

    const peso = parseFloat(data.field1) / 1000;
    document.getElementById("pesoAttuale").innerText = peso.toFixed(3) + " kg";

    const dt = new Date(data.created_at);
    const oraLocale = dt.toLocaleString("it-IT", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });

    document.getElementById("ultimoAgg").innerHTML =
        `<span class="badge">${oraLocale}</span>`;
}

// ----------------------
// VARIAZIONE 24 ORE (VERSIONE PRECISA)
// ----------------------
async function aggiornaVariazione24h() {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=300`;
    const r = await fetch(url);
    const data = await r.json();

    if (!data.feeds.length) return;

    const now = new Date();
    const targetTime = now.getTime() - (24 * 60 * 60 * 1000);

    let peso24h = null;
    let pesoUltimo = parseFloat(data.feeds[data.feeds.length - 1].field1) / 1000;

    let minDiff = Infinity;

    data.feeds.forEach(f => {
        if (!f.field1) return;

        const t = new Date(f.created_at).getTime();
        const diff = Math.abs(t - targetTime);

        if (diff < minDiff) {
            minDiff = diff;
            peso24h = parseFloat(f.field1) / 1000;
        }
    });

    if (peso24h === null) return;

    const variazione = pesoUltimo - peso24h;

    const varElem = document.getElementById("var24h");

    let arrow = "â†’";
    let color = "#555";

    if (variazione > 0) {
        arrow = "â†‘";
        color = "#4CAF50";
    } else if (variazione < 0) {
        arrow = "â†“";
        color = "#E53935";
    }

    varElem.innerHTML = `
        <span style="color:${color}; font-size:1.4em; font-weight:bold;">
            ${arrow}
        </span>
        ${(variazione >= 0 ? "+" : "") + variazione.toFixed(3)} kg
    `;

    if (chartVar) chartVar.destroy();

    const ctx = document.getElementById("graficoVar24h").getContext("2d");

    chartVar = new Chart(ctx, {
        type: "bar",
        data: {
            labels: ["24h"],
            datasets: [{
                data: [variazione],
                backgroundColor: color,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: "#444" } },
                y: { ticks: { color: "#444" } }
            }
        }
    });
}

// ----------------------
// STATO BILANCIA
// ----------------------
async function aggiornaStato() {
    try {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPIKey}`;
        const r = await fetch(url);
        const data = await r.json();

        document.getElementById("statoConn").innerHTML =
            `<span class="stato-online">ðŸŸ¢ Online</span>`;

        document.getElementById("reteWifi").innerText = data.field3 || "N/D";

    } catch {
        document.getElementById("statoConn").innerHTML =
            `<span class="stato-offline">ðŸ”´ Offline</span>`;
    }
}

// ----------------------
// ULTIMI 10 PESI
// ----------------------
async function aggiornaTabella() {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=10`;
    const r = await fetch(url);
    const data = await r.json();

    const tbody = document.getElementById("tabellaPesi");
    tbody.innerHTML = "";

    data.feeds.reverse().forEach(f => {
        const peso = (parseFloat(f.field1) / 1000).toFixed(3);
        const ora = f.created_at.replace("T", " ").replace("Z", "");

        tbody.innerHTML += `<tr><td>${ora}</td><td>${peso}</td></tr>`;
    });
}

// ----------------------
// GRAFICO PRINCIPALE
// ----------------------
async function caricaGrafico(resultsCount) {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=${resultsCount}`;
    const r = await fetch(url);
    const data = await r.json();

    const labels = data.feeds.map(f => f.created_at.replace("T", " ").replace("Z", ""));
    const valori = data.feeds.map(f => parseFloat(f.field1) / 1000);

    if (chart) chart.destroy();

    const ctx = document.getElementById("graficoPeso").getContext("2d");

    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Peso (kg)",
                data: valori,
                backgroundColor: "#4CAF50",
                borderColor: "#388E3C",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: "#444" } },
                y: { ticks: { color: "#444" } }
            },
            plugins: {
                legend: { labels: { color: "#444" } }
            }
        }
    });
}

// ----------------------
// AGGIORNAMENTO AUTOMATICO
// ----------------------
function aggiornaDashboard() {
    aggiornaPesoAttuale();
    aggiornaVariazione24h();
    aggiornaStato();
    aggiornaTabella();
    caricaGrafico(96);
}

aggiornaDashboard();
setInterval(aggiornaDashboard, 30000);
</script>

</body>
</html>
