<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Bilancia 1 - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #eee;
        margin: 0;
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 10px;
    }
    .card {
        background: #1c1c1c;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .big-value {
        font-size: 3rem;
        text-align: center;
        font-weight: bold;
        color: #4CAF50;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    table th, table td {
        padding: 8px;
        border-bottom: 1px solid #333;
        text-align: center;
    }
    .btn-group button {
        background: #333;
        color: #eee;
        border: none;
        padding: 10px 15px;
        margin-right: 5px;
        cursor: pointer;
        border-radius: 5px;
    }
    .btn-group button:hover {
        background: #555;
    }
</style>
</head>

<body>

<h1>Bilancia 1 - Dashboard</h1>

<div class="card">
    <h2>Peso Attuale</h2>
    <div id="pesoAttuale" class="big-value">--.- kg</div>
</div>

<div class="card">
    <h2>Stato Bilancia</h2>
    <p><strong>Stato:</strong> <span id="statoConn">--</span></p>
    <p><strong>Ultimo aggiornamento:</strong> <span id="ultimoAgg">--</span></p>
    <p><strong>Rete WiFi:</strong> <span id="reteWifi">--</span></p>
</div>

<div class="card">
    <h2>Ultimi 10 Pesi</h2>
    <table>
        <thead>
            <tr><th>Ora</th><th>Peso (kg)</th></tr>
        </thead>
        <tbody id="tabellaPesi"></tbody>
    </table>
</div>

<div class="card">
    <h2>Storico Peso</h2>
    <div class="btn-group">
        <button onclick="caricaGrafico(1)">Ultime 24 ore</button>
        <button onclick="caricaGrafico(7)">Ultimi 7 giorni</button>
        <button onclick="caricaGrafico(30)">Ultimi 30 giorni</button>
    </div>
    <canvas id="graficoPeso" height="120"></canvas>
</div>

<script>
const channelID = 3171602;
const readAPIKey = "JQ1UUYT4R4T83V0V";

let chart;

// ----------------------
// PESO ATTUALE
// ----------------------
async function aggiornaPesoAttuale() {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`;
    const r = await fetch(url);
    const data = await r.json();

    const peso = parseFloat(data.field1) / 1000;
    document.getElementById("pesoAttuale").innerText = peso.toFixed(3) + " kg";

    document.getElementById("ultimoAgg").innerText = data.created_at.replace("T", " ").replace("Z", "");
}

// ----------------------
// STATO BILANCIA
// ----------------------
async function aggiornaStato() {
    try {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPIKey}`;
        const r = await fetch(url);
        const data = await r.json();

        document.getElementById("statoConn").innerText = "Online";
        document.getElementById("reteWifi").innerText = data.field3 || "N/D";
    } catch {
        document.getElementById("statoConn").innerText = "Offline";
    }
}

// ----------------------
// ULTIMI 10 PESI
// ----------------------
async function aggiornaTabella() {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=10`;
    const r = await fetch(url);
    const data = await r.json();

    const tbody = document.getElementById("tabellaPesi");
    tbody.innerHTML = "";

    data.feeds.reverse().forEach(f => {
        const peso = (parseFloat(f.field1) / 1000).toFixed(3);
        const ora = f.created_at.replace("T", " ").replace("Z", "");

        tbody.innerHTML += `<tr><td>${ora}</td><td>${peso}</td></tr>`;
    });
}

// ----------------------
// GRAFICO
// ----------------------
async function caricaGrafico(giorni) {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&days=${giorni}`;
    const r = await fetch(url);
    const data = await r.json();

    const labels = data.feeds.map(f => f.created_at.replace("T", " ").replace("Z", ""));
    const valori = data.feeds.map(f => parseFloat(f.field1) / 1000);

    if (chart) chart.destroy();

    const ctx = document.getElementById("graficoPeso").getContext("2d");
    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Peso (kg)",
                data: valori,
                borderColor: "#4CAF50",
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            scales: {
                x: { ticks: { color: "#ccc" } },
                y: { ticks: { color: "#ccc" } }
            },
            plugins: {
                legend: { labels: { color: "#ccc" } }
            }
        }
    });
}

// ----------------------
// AGGIORNAMENTO AUTOMATICO
// ----------------------
function aggiornaDashboard() {
    aggiornaPesoAttuale();
    aggiornaStato();
    aggiornaTabella();
    caricaGrafico(1);
}

aggiornaDashboard();
setInterval(aggiornaDashboard, 30000);
</script>

</body>
</html>
