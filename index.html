<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Bilancia IoT - Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        padding: 20px;
        color: #333;
    }
    h1 {
        text-align: center;
        margin-bottom: 10px;
    }
    .card {
        background: white;
        padding: 20px;
        margin: 20px auto;
        border-radius: 10px;
        max-width: 800px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    canvas {
        width: 100%;
        height: 300px;
    }
</style>
</head>
<body>

<h1>ðŸ“Š Dashboard Bilancia IoT</h1>

<div class="card">
    <h2>Ultimo Peso</h2>
    <p id="lastWeight">Caricamento...</p>
</div>

<div class="card">
    <h2>Variazione Ultima Ora</h2>
    <canvas id="chart1h"></canvas>
</div>

<div class="card">
    <h2>Variazione Ultime 6 Ore</h2>
    <canvas id="chart6h"></canvas>
</div>

<div class="card">
    <h2>Variazione Ultime 24 Ore</h2>
    <canvas id="chart24h"></canvas>
</div>

<script>
const CHANNEL_ID = "3171602";  
const API_KEY = "JQ1UUYT4R4T83V0V";  

async function fetchData(minutes) {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/1.json?api_key=${API_KEY}&minutes=${minutes}&results=500`;
    const response = await fetch(url);
    const data = await response.json();
    return data.feeds.map(f => ({
        time: f.created_at,
        value: parseFloat(f.field1)
    }));
}

async function updateLastWeight() {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/1/last.json?api_key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    document.getElementById("lastWeight").innerText = data.field1 + " g";
}

function createChart(canvasId, data, label) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => new Date(d.time).toLocaleTimeString()),
            datasets: [{
                label: label,
                data: data.map(d => d.value),
                borderColor: "#007bff",
                backgroundColor: "rgba(0,123,255,0.2)",
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
}

async function loadCharts() {
    updateLastWeight();

    const data1h = await fetchData(60);
    createChart("chart1h", data1h, "Ultima Ora");

    const data6h = await fetchData(360);
    createChart("chart6h", data6h, "Ultime 6 Ore");

    const data24h = await fetchData(1440);
    createChart("chart24h", data24h, "Ultime 24 Ore");
}

loadCharts();
setInterval(loadCharts, 60000); // aggiorna ogni minuto
</script>

</body>
</html>
